{% extends "layout.html" %}
{% block title %}Editing {{booking.eventName}}{% endblock %}
{% block content %}
<div class="row">
  <div class="col-xs-12 col-sm-6 col-sm-offset-3 col-md-6 col-md-offset-3">
    <h2>Editing Booking</h2>
    <p>Created By {{booking.creator.firstName}} {{booking.creator.lastName}}</p>
    <hr>
    <form class="form-horizontal" method="POST">
        {{ html.csrf_token()}}
        {{ html.form_group('text', 'Event Name', placeholder="Name", value=booking.eventName) }}
        {{ html.form_group('text', 'Start', value=booking.startTime|datetime, inputAttributes={'disabled': 'disabled'})}}
        {{ html.form_group('text', 'End', value=booking.endTime|datetime, inputAttributes={'disabled': 'disabled'})}}
        {{ html.form_group("number", "Discount Percent", placeholder="10%", value=booking.discountPercent, min=0, max=100) }}
        {{ html.form_group("number", "Discount Amount", placeholder="$10", value=booking.discountAmount, min=0) }}
        {{ html.form_group("select", "Organization", options=html.to_keyval(orgs, base={0: "None"}), value=booking.contact.organization_id) }}
        {{ html.form_group("select", "Contact", options=html.to_keyval(contacts), value=booking.contact_id) }}
        {{ html.form_group("multiselect", "Rooms", options=html.to_keyval(rooms), value=html.to_strings(booking.selectedRoomIds()))}}
        <hr>
        <table class="table table-condensed table-hover table-responsive table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Caterer</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for dish in dishes %}
                <tr>
                    <td>{{dish.name}}</td>
                    <td>{{dish.caterer.name}}</td>
                    <td><input type="number" min="0" class="dish-input" name="{{dish.id}}_dish" value="{{ booking.foodList()[dish.id] if dish.id in booking.foodList() else 0  }}" data-price="{{dish.price|round(2)}}"></td>
                    <td>{{dish.price|currency}}</td>
                    <td><span id="{{dish.id}}_total" class="pull-right">$0</span></td>
                </tr>
                {% endfor %}
                <tr class="active">
                    <td colspan="4">Caterering Total</td>
                    <td><span id="catereringTotal" class="pull-right">$0</span></td>
                </tr>
                {% for room in booking.selectedRooms() %}
                    <tr id="room-row-{{room.id}}"} class='room-rows'>
                        <td colspan="2">{{room.name}}</td>
                        <td>{{booking.duration|round(2)}} hours</td>
                        <td>{{room.price|currency}} /hour</td>
                        <td><span class="pull-right">{{room.getTotal(booking.duration)|currency}}</span></td>
                    </tr>
                {% endfor %}
                <tr class="active">
                    <td colspan="4">Room Total</td>
                    <td><span id="roomTotal" class="pull-right">{{booking.roomCombo.price|currency}}</span></td>
                </tr>
                <tr>
                    <td colspan="4">Subtotal</td>
                    <td><span id="subtotal" class="pull-right"></span></td>
                </tr>
                <tr>
                    <td colspan="4">Discount</td>
                    <td><span id="discountTotal" class="pull-right"></span></td>
                </tr>
                <tr>
                    <td colspan="4">Total</td>
                    <td> <span id="finalTotal" class="pull-right"></span></td>
                </tr>
            </tbody>
        </table> 
    </form>
  </div>
</div>
{% endblock %}
{% block script %}
<script>
    
    $('#Rooms').multiselect();
    var orgData = {{ contactjson|tojson }};
    var roomData = {{ roomjson|tojson }};
    function updateCaterering() {
        var cTotal = 0;
        $('.dish-input').each(function(){
            var total = (this.dataset.price * this.value);
            cTotal += total;
            $('#' + this.name.replace('_dish', '') + '_total').html('$' + total.toFixed(2));
        });
        $('#catereringTotal').html('$' + cTotal.toFixed(2));
        updateTotal();
    }

    function updateTotal() {

    }

    function updateRooms() {
        //room-row-room.id
        var values = $('#Rooms').val();
        for(var key in values) {
            var val = values[key];
            var row = $("#room-row-" + val);
            if (row.length === 0){
                console.log("adding row " + val);
            }
        }
        $('.room-rows').each(function(){
            if ($.inArray(String(this.id.replace('room-row-','')), values) == -1){
                console.log('removing row ' + this.id);
                $(this).remove();
            }
        });
        updateTotal();
    }

    function filterContacts() {
        var orgId = $("#Organization").val();
        var flag = false;
        $('#Contact > option').each(function(){
            var data = orgData[orgId];
            if (this.value in data) {
                $(this).show();
                $(this).removeAttr('disabled');
                $(this)
                if (!flag){
                    flag=true;
                    if (!($('#Contact').val() in data)) {
                        $('#Contact').val(this.value);
                    }
                }
            } else {
                $(this).hide();
                //set the disabled attr as a fall back
                $(this).attr('disabled','disabled');
            }
        })
    }
    filterContacts();
    updateCaterering();

    //return ((self.subTotal() - self.discountAmount) * self.discountPercent/100) + self.discountAmount


    //$('#Rooms .multiselect').addClass('btn-error');
    //$('#Rooms').parent().parent().toggleClass('has-error')
    $('#Rooms').on('change', updateRooms);
    $('.dish-input').on('change', updateCaterering);
    $('#Organization').on('change', filterContacts);
</script>
{% endblock %}
